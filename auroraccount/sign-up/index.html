<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>auroraccount Sign Up</title>
  <!-- fonts!!!!! very important for good looking website!!! -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
<!-- i put in my fonts after the css file. i'm an idiot. -->
 <link rel="stylesheet" href="style.css">
</head>
<body>

 

  <div id="signup-container">
  <h2>Sign Up</h2><br><br>
  <form id="signup-form">

   <label for="signup-username">Username:</label>
   <input type="text" id="signup-username" minlength="3" maxlength="21" required><br><br>
   <small>Username must have at least 3 characters, and no more than 21 characters.</small><br><br>
   
   <label for="signup-email">Email:</label>
   <input type="email" id="signup-email" required><br><br>

   <label for="signup-password">Password:</label>
   <input type="password" id="signup-password" minlength="8" required><br><br>
   <small>Password must have at least 8 characters.</small><br><br>

   <div id="error-box"></div><br>
   <button type="submit" id="signup-button">Sign Up</button><br><br>
   <div id="sign-in-hyperlink">
   <a href="https://mii-man.github.io/aurorachatweb/auroraccount/sign-in">Sign In</a><br><br>
  </div>
  </form>
</div>




<script type="module">
  // 1. IMPORT everything first
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, sendEmailVerification} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // 2. CONFIG (Make sure this is your NEW key from the new project!)
  const firebaseConfig = {
    apiKey: "AIzaSyBQsx7Bf0_tygHQHjWxiHWK49Bz6JntTdU", 
    authDomain: "auroraccountdata-fd4d1.firebaseapp.com",
    projectId: "auroraccountdata-fd4d1",
    storageBucket: "auroraccountdata-fd4d1.firebasestorage.app",
    messagingSenderId: "897601468342",
    appId: "1:897601468342:web:55e2c568eb188c94fcb317",
    measurementId: "G-L8EECSRDWB"
  };

  // 3. INITIALIZE Firebase Services
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 4. LOGIC for the form
  const signupForm = document.getElementById('signup-form');
  const errorBox = document.getElementById('error-box');
signupForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  errorBox.innerText = "";

  const username = document.getElementById('signup-username').value.toLowerCase().trim();
  const email = document.getElementById('signup-email').value;
  const password = document.getElementById('signup-password').value;

  try {
    // 1. CHECK: See if username is taken
    const userRef = doc(db, "usernames", username);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
      throw new Error("This username is already taken.");
    }

    // 2. CREATE AUTH: This is the part most likely to fail (weak password, etc.)
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    // 3. SAVE TO FIRESTORE: Only happens if Step 2 succeeded
    try {
      await setDoc(doc(db, "usernames", username), {
        email: email,
        uid: user.uid
      });
      alert("Account created successfully!");
    } catch (dbError) {
      // CRITICAL: If saving the username fails, we should delete the Auth account 
      // so the user can try again without "email already in use" errors.
      await user.delete(); 
      throw new Error("Database error. Please try again.");
    }

  } catch (error) {
    errorBox.innerText = error.message;
    errorBox.style.color = "red";
  }
});
</script>



</body>
</html>
